pipeline {
    agent any
    parameters {
        choice(name: 'PROMOTION_FLOW', choices: ['NPE->UAT->PROD', 'NPE->UAT', 'UAT->PROD'], description: 'Select Promotion Flow')
        booleanParam(name: 'REPUBLISH_BEFORE_PROMOTING', defaultValue: false, description: 'Republish before promoting')
        booleanParam(name: 'KEEP_PUBLISHED_IN_LOWER_ENV', defaultValue: true, description: 'Keep pipeline published in lower environment after promotion')
        string(name: 'DAG_PREFIX', defaultValue: 'CAGBPOFLN_', description: 'DAG Prefix')
        choice(name: 'RETRIES', choices: ['0', '1', '2'], description: 'Number of retries on failure')
        text(name: 'PIPELINES_TO_PROMOTE', description: 'List of pipelines to promote, one per line', defaultValue: 'dummy-customer/pipeline-name1\ndummy-customer/pipeline-name2')
    }

    environment {
        NPE_API = 'https://global-star.alpha.km/config/'
        UAT_API = 'https://global-star.uat.km/config/'
        PROD_API = 'https://global-star.prd.km/config/'
        BUCKET_UAT = 'northamerica-northeast1-ca-gbp-consumer-uat'
        BUCKET_PROD = 'northamerica-northeast1-ca-gbp-consumer-prd'
        NPE_AUTH_URL = 'https://ram-ntr-app.npe.pk/oauth2/token'
        UAT_PROD_AUTH_URL = 'https://ram-ntr-app.uat.pk/oauth2/token'
    }

    stages {
        stage('Generate OAuth Tokens') {
            steps {
                script {
                    // Generate OAuth tokens for NPE and UAT/PROD
                    env.NPE_TOKEN = getOAuthToken(env.NPE_AUTH_URL, env.NPE_CREDENTIALS_USR, env.NPE_CREDENTIALS_PSW)
                    env.UAT_PROD_TOKEN = getOAuthToken(env.UAT_PROD_AUTH_URL, env.UAT_PROD_CREDENTIALS_USR, env.UAT_PROD_CREDENTIALS_PSW)
                }
            }
        }

        stage('Promotion Process') {
            steps {
                script {
                    pipelines = params.PIPELINES_TO_PROMOTE.split("\n")
                    pipelines.each { pipeline -> 
                        handlePromotion(pipeline, params.PROMOTION_FLOW)
                    }
                }
            }
        }

        stage('Summary Report') {
            steps {
                script {
                    sendSummaryReport()
                }
            }
        }
    }
}

def getOAuthToken(authUrl, username, password) {
    def response = httpRequest(
        url: authUrl,
        httpMode: 'POST',
        contentType: 'APPLICATION_FORM',
        requestBody: "grant_type=client_credentials&client_id=${username}&client_secret=${password}",
        customHeaders: [[name: 'Content-Type', value: 'application/x-www-form-urlencoded']]
    )
    def json = new groovy.json.JsonSlurperClassic().parseText(response.content)
    return json.access_token
}

def handlePromotion(pipeline, promotionFlow) {
    def customer = pipeline.split('/')[0]
    def pipelineName = pipeline.split('/')[1]
    def parentDAGFolder = "${params.DAG_PREFIX}${pipelineName.toUpperCase().replace('-', '_')}"
    
    if (promotionFlow == 'NPE->UAT->PROD' || promotionFlow == 'NPE->UAT') {
        promoteToUAT(customer, pipelineName, parentDAGFolder)
    }
    if (promotionFlow == 'NPE->UAT->PROD' || promotionFlow == 'UAT->PROD') {
        promoteToProd(customer, pipelineName, parentDAGFolder)
    }
}

def promoteToUAT(customer, pipelineName, parentDAGFolder) {
    unpublishInUAT(customer, pipelineName, parentDAGFolder)
    promoteFromNPEToUAT(customer, pipelineName, parentDAGFolder)
    publishInUAT(customer, pipelineName, parentDAGFolder)
}

def promoteToProd(customer, pipelineName, parentDAGFolder) {
    unpublishInProd(customer, pipelineName, parentDAGFolder)
    promoteFromUATToProd(customer, pipelineName, parentDAGFolder)
    publishInProd(customer, pipelineName, parentDAGFolder)
}

def publishInNPE(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${NPE_API}publish", httpMode: 'POST', 
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.NPE_TOKEN}"]]
    handleApiResponse(response, "Publish NPE")
}

def publishInUAT(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${UAT_API}publish", httpMode: 'POST',
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.UAT_PROD_TOKEN}"]]
    handleApiResponse(response, "Publish UAT")
}

def publishInProd(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${PROD_API}publish", httpMode: 'POST',
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.UAT_PROD_TOKEN}"]]
    handleApiResponse(response, "Publish PROD")
}

def unpublishInNPE(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${NPE_API}unpublish", httpMode: 'POST',
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.NPE_TOKEN}"]]
    handleApiResponse(response, "Unpublish NPE")
}

def unpublishInUAT(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${UAT_API}unpublish", httpMode: 'POST',
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.UAT_PROD_TOKEN}"]]
    handleApiResponse(response, "Unpublish UAT")
}

def unpublishInProd(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${PROD_API}unpublish", httpMode: 'POST',
        requestBody: constructPublishRequestBody(customer, pipelineName, parentDAGFolder),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.UAT_PROD_TOKEN}"]]
    handleApiResponse(response, "Unpublish PROD")
}

def promoteFromNPEToUAT(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${NPE_API}promote", httpMode: 'POST',
        requestBody: constructPromoteRequestBody(customer, pipelineName, parentDAGFolder, env.BUCKET_UAT),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.NPE_TOKEN}"]]
    handleApiResponse(response, "Promote NPE to UAT")
}

def promoteFromUATToProd(customer, pipelineName, parentDAGFolder) {
    def response = httpRequest url: "${UAT_API}promote", httpMode: 'POST',
        requestBody: constructPromoteRequestBody(customer, pipelineName, parentDAGFolder, env.BUCKET_PROD),
        customHeaders: [[name: 'Authorization', value: "Bearer ${env.UAT_PROD_TOKEN}"]]
    handleApiResponse(response, "Promote UAT to PROD")
}

def constructPublishRequestBody(customer, pipelineName, parentDAGFolder) {
    return """{
        "customer": "${customer}",
        "name": "${pipelineName}",
        "bu": "ca",
        "parentDAGFolder": "${parentDAGFolder}"
    }"""
}

def constructPromoteRequestBody(customer, pipelineName, parentDAGFolder, bucket) {
    return """{
        "customer": "${customer}",
        "name": "${pipelineName}",
        "bu": "ca",
        "parentDAGFolder": "${parentDAGFolder}",
        "bucket": "${bucket}"
    }"""
}

def handleApiResponse(response, step) {
    if (response.status != 200) {
        error("API call failed during step ${step}. Response: ${response.content}")
    }
}

def sendSummaryReport() {
    // This is where we generate and send the summary email report
    // Using pipeline build status and step results
    echo "Sending summary report to specified emails..."
}
