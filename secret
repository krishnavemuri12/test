pipeline {
    agent any
    environment {
        SECRET_FILE_PATH = credentials('')
    }
    
    stages {
        stage('User Verification') {
            steps {
                script {
                    // Get the user email using a secure method
                    def userEmail = env.BUILD_USER_EMAIL ?: 'default@equifax.com' // Replace with default if necessary
                    
                    // Verification input
                    input message: "Do you want to receive the secrets via email?", ok: 'Send Secrets'
                    
                    // Read the secret file without exposing its content
                    def secretContent = readFile(file: SECRET_FILE_PATH)
                    
                    // Send the secrets via email
                    emailext(
                        to: userEmail,
                        subject: "Your Requested Secrets from Jenkins",
                        body: """
                            Hi,

                            You have triggered the Jenkins pipeline, and here are your requested secrets:

                            ${secretContent}

                            Best regards,
                            Jenkins
                        """
                    )
                }
            }
        }
    }
    
    post {
        always {
            // Securely clean up the secret file
            sh 'rm -f ${SECRET_FILE_PATH}' // Ensures the file is deleted after usage
            echo 'Pipeline execution completed. Secrets have been sent to your email.'
        }
    }
}
