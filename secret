pipeline {
    agent any
    environment {
        SECRET_FILE_PATH = credentials('')
    }
    
    stages {
        // Stage 1: User Verification
        stage('User Verification') {
            steps {
                script {
                    // Retrieve the email of the user who triggered the pipeline
                    def userEmail = currentBuild.rawBuild.getCause(hudson.model.Cause$UserIdCause).getUserName()

                    // User verification prompt
                    input message: "Do you want to receive the secrets via email?", ok: 'Send Secrets'
                }
            }
        }

        // Stage 2: Send Secrets via Email
        stage('Send YAML Secret via Email') {
            steps {
                script {
                    // Read the content of the secret file
                    def secretContent = readFile("${SECRET_FILE_PATH}")
                    
                    // Email subject and body
                    def mailSubject = "Your Requested YAML Secrets from Jenkins"
                    def mailBody = """
                        Hi,

                        You have triggered the Jenkins pipeline, and here are your requested secrets:

                        ${secretContent}

                        Best regards,
                        Jenkins
                    """
                    
                    // Send the secrets via email
                    emailext(
                        to: "${userEmail}@yourdomain.com",
                        subject: mailSubject,
                        body: mailBody
                    )
                }
            }
        }
    }

    post {
        always {
            // Print a generic message to avoid revealing secrets in the console
            echo 'Pipeline execution completed. Secrets have been sent to your email.'
        }
    }
}
